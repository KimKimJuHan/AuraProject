name: Game Data Collector

on:
  schedule:
    # ⚠️ 주의: GitHub Actions는 UTC(세계 표준시) 기준입니다.
    # '0 10 * * *' = UTC 10:00 = 한국 시간(KST) 오후 7:00
    # 한국 시간 새벽 4시에 돌리고 싶다면 '0 19 * * *' (전날 오후 7시 UTC) 등으로 설정해야 합니다.
    - cron: '0 10 * * *' 
    
  workflow_dispatch: # 수동 실행 버튼도 유지 (테스트용)

jobs:
  build:
    runs-on: ubuntu-latest

    # 환경 변수 설정
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      ITAD_API_KEY: ${{ secrets.ITAD_API_KEY }}
      TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
      TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
      CHZZK_CLIENT_ID: ${{ secrets.CHZZK_CLIENT_ID }}
      CHZZK_CLIENT_SECRET: ${{ secrets.CHZZK_CLIENT_SECRET }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install Dependencies
      run: |
        cd backend
        npm install

    # 1단계: 메타데이터 수집
    - name: 1. Seed Game Metadata (Price & Game List)
      run: |
        cd backend
        node scripts/metadata_seeder.js

    # 2단계: 카테고리 매핑
    - name: 2. Seed Category Mapping (Trend Source)
      run: |
        cd backend
        node scripts/category_seeder.js

    # 3단계: 메인 수집기 실행
    - name: 3. Run Main Collector
      run: |
        cd backend
        node scripts/collector.js