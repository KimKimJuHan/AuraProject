name: Game Data Collector

on:
  # schedule:
  #   - cron: '0 10 * * *' # 매일 자동 실행은 비활성화 (대량 수집 시 부하 방지)
  workflow_dispatch: # ★ 수동 실행 버튼 활성화 (필요할 때만 클릭해서 실행)

jobs:
  build:
    runs-on: ubuntu-latest

    # 환경 변수 설정
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      ITAD_API_KEY: ${{ secrets.ITAD_API_KEY }}
      TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
      TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
      CHZZK_CLIENT_ID: ${{ secrets.CHZZK_CLIENT_ID }}
      CHZZK_CLIENT_SECRET: ${{ secrets.CHZZK_CLIENT_SECRET }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install Dependencies
      run: |
        cd backend
        npm install

    # 1단계: 최신 게임 목록 및 가격 정보 ID(UUID) 갱신
    # ★ 경로 수정: scripts/metadata_seeder.js
    - name: 1. Seed Game Metadata (Price & Game List)
      run: |
        cd backend
        node scripts/metadata_seeder.js

    # 2단계: 갱신된 게임 목록에 대한 트위치/치지직 카테고리 매핑
    # ★ 경로 수정: scripts/category_seeder.js
    - name: 2. Seed Category Mapping (Trend Source)
      run: |
        cd backend
        node scripts/category_seeder.js

    # 3단계: 완성된 족보를 바탕으로 실제 가격/트렌드/상세정보 수집
    # ★ 경로 수정: scripts/collector.js
    - name: 3. Run Main Collector
      run: |
        cd backend
        node scripts/collector.js